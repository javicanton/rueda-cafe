<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rueda de Sabores del Caf茅</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f5f5f5;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      min-height: 100vh;
    }

    h1 {
      margin-bottom: 10px;
      color: #333;
    }

    #container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      padding: 20px;
      margin-top: 20px;
    }

    svg {
      display: block;
    }

    .arc {
      cursor: pointer;
      transition: opacity 0.2s;
      stroke: white;
      stroke-width: 2;
    }

    .arc:hover {
      opacity: 0.8;
    }

    .arc-text {
      font-size: 12px;
      fill: white;
      pointer-events: none;
      text-anchor: middle;
      font-weight: 500;
    }

    #info {
      margin-top: 20px;
      padding: 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      max-width: 800px;
      min-height: 80px;
    }

    .info-title {
      font-size: 20px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }

    .info-path {
      font-size: 14px;
      color: #666;
      margin-bottom: 12px;
    }

    .info-desc {
      font-size: 14px;
      color: #555;
      line-height: 1.6;
    }

    .placeholder {
      color: #999;
      font-style: italic;
      text-align: center;
      padding: 40px;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .error {
      color: #dc2626;
      text-align: center;
      padding: 20px;
      background: #fee;
      border-radius: 8px;
      margin: 20px;
    }
</style>
</head>
<body>
  <h1> Rueda de Sabores del Caf茅</h1>

  <div id="container">
    <svg id="sunburst" width="800" height="800"></svg>
      </div>

  <div id="info">
    <div class="loading">Cargando datos...</div>
  </div>

  <!-- D3.js desde CDN -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  
  <script>
    // Configuraci贸n b谩sica
    const width = 800;
    const height = 800;
    const radius = Math.min(width, height) / 2;

    // SVG setup
    const svg = d3.select('#sunburst');
    const g = svg.append('g')
      .attr('transform', `translate(${width/2}, ${height/2})`);

    // Colores por defecto
    const color = d3.scaleOrdinal(d3.schemeSet3);

    // Funci贸n para parsear CSV correctamente (maneja comas dentro de comillas)
    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current.trim());
      return result;
    }

    // Funci贸n para convertir CSV a JSON jer谩rquico
    function csvToHierarchy(csvText) {
      const lines = csvText.trim().split('\n');
      
      // Esperamos: Nivel1,Nivel2,Nivel3,Color,... (hay m谩s columnas pero solo usamos estas 4)
      const data = { name: 'root', children: [] };
      const nivel1Map = new Map();
      const nivel2Map = new Map();

      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        
        const values = parseCSVLine(line);
        const [n1, n2, n3, colorVal, definicion] = values;

        if (!n1) continue;

        // Nivel 1
        if (!nivel1Map.has(n1)) {
          const child1 = { 
            name: n1, 
            children: [], 
            color: colorVal || color(n1),
            description: definicion || ''
          };
          nivel1Map.set(n1, child1);
          data.children.push(child1);
        }

        const parent1 = nivel1Map.get(n1);

        // Nivel 2
        if (n2) {
          const key2 = `${n1}-${n2}`;
          if (!nivel2Map.has(key2)) {
            const child2 = { 
              name: n2, 
              children: [], 
              color: colorVal || color(n2),
              description: definicion || ''
            };
            nivel2Map.set(key2, child2);
            parent1.children.push(child2);
          }

          const parent2 = nivel2Map.get(key2);

          // Nivel 3
          if (n3) {
            parent2.children.push({ 
              name: n3, 
              value: 1,
              color: colorVal || color(n3),
              description: definicion || ''
            });
          }
        }
      }

      return data;
    }

    // Funci贸n principal para renderizar el sunburst
    function renderSunburst(data) {
      // Limpiar SVG
      g.selectAll('*').remove();

      // Crear jerarqu铆a
      const root = d3.hierarchy(data)
        .sum(d => d.value || 0)
        .sort((a, b) => b.value - a.value);

      // Crear partici贸n
      const partition = d3.partition()
        .size([2 * Math.PI, radius]);

    partition(root);

      // Crear arco
    const arc = d3.arc()
        .startAngle(d => d.x0)
        .endAngle(d => d.x1)
        .padAngle(d => Math.min((d.x1 - d.x0) / 2, 0.005))
        .padRadius(radius / 2)
        .innerRadius(d => d.y0)
        .outerRadius(d => d.y1 - 1);

      // Dibujar arcos
      const paths = g.selectAll('path')
        .data(root.descendants().filter(d => d.depth > 0))
        .join('path')
        .attr('class', 'arc')
      .attr('d', arc)
        .attr('fill', d => d.data.color || color(d.data.name))
        .attr('fill-opacity', d => {
          // M谩s oscuro en niveles m谩s profundos
          return 1 - (d.depth * 0.15);
        })
        .on('click', (event, d) => {
          showInfo(d);
        });

      // Agregar texto (solo para segmentos grandes)
      g.selectAll('text')
        .data(root.descendants().filter(d => {
          return d.depth > 0 && (d.x1 - d.x0) > 0.1;
        }))
        .join('text')
        .attr('class', 'arc-text')
        .attr('transform', d => {
          const x = (d.x0 + d.x1) / 2 * 180 / Math.PI;
          const y = (d.y0 + d.y1) / 2;
          return `rotate(${x - 90}) translate(${y},0) rotate(${x < 180 ? 0 : 180})`;
        })
        .attr('dy', '0.35em')
        .text(d => d.data.name);

      // Mostrar info del primer elemento
      if (root.children && root.children.length > 0) {
        showInfo(root.children[0]);
      }
    }

    // Funci贸n para mostrar informaci贸n del segmento
    function showInfo(d) {
      const infoDiv = document.getElementById('info');
      
      // Construir ruta (breadcrumb)
      const path = d.ancestors().reverse().map(n => n.data.name).filter(n => n !== 'root').join(' > ');
      
      const descHTML = d.data.description ? `<p><strong>Descripci贸n:</strong> ${d.data.description}</p>` : '';
      
      infoDiv.innerHTML = `
        <div class="info-title">${d.data.name}</div>
        <div class="info-path">${path}</div>
        <div class="info-desc">
          ${descHTML}
          <p><strong>Nivel:</strong> ${d.depth} de 3</p>
        </div>
      `;
    }

    // Cargar datos desde CSV (funciona en GitHub Pages y local)
    async function loadData() {
      // Lista de URLs a intentar (primero la relativa, luego GitHub raw como fallback)
        const urls = [
          './coffee_flavor_wheel.csv',
          'coffee_flavor_wheel.csv',
          'https://raw.githubusercontent.com/javicanton/rueda-cafe/main/coffee_flavor_wheel.csv'
        ];
      
      for (let url of urls) {
        try {
          const response = await fetch(url);
          if (response.ok) {
            const csvText = await response.text();
            const hierarchyData = csvToHierarchy(csvText);
            renderSunburst(hierarchyData);
            
            document.getElementById('info').innerHTML = `
              <div class="placeholder">Haz clic en un segmento para ver su informaci贸n</div>
            `;
            return; // xito, salir
          }
        } catch (error) {
          console.log(`No se pudo cargar desde ${url}, intentando siguiente...`);
          continue;
        }
      }
      
      // Si llegamos aqu铆, ninguna URL funcion贸
      document.getElementById('info').innerHTML = `
        <div class="error">
          <strong>Error:</strong> No se pudo cargar el archivo CSV desde ninguna ubicaci贸n.<br>
          <small>Verifica que el archivo coffee_flavor_wheel_3niveles_lexicon_es.csv existe.</small>
        </div>
      `;
    }

    // Cargar datos al iniciar
    loadData();
  </script>
</body>
</html>
